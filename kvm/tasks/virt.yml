---
- name: Check if VM disk already exists
  stat:
    path: "{{ item.stdout_lines[0] }}/vm_{{ item.item.name }}"
  when:
    - item.item.name not in kvm_existing_vms.list_vms
    - item.item.state|d('running') != 'undefined'
  with_items: "{{ kvm_pool_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  changed_when: kvm_disk_stat.stat.exists
  register: kvm_disk_stat

- name: Fails is VM disk image already exists
  fail:
    msg: "FATAL: VM DISK IMAGE ALREADY EXISTS"
  when:
    - kvm_disk_stat is defined
    - item.changed
    - item.stat.exists
    - not kvm_accept_existing_disks
  with_items: "{{ kvm_disk_stat.results }}"
  loop_control:
    label: "{{ (item.stat|default(dict(path='null')))['path']|d('null') }}"

- import_tasks: get_images.yml

- import_tasks: sysprep.yml

- name: Virt undefine
  virt:
    command: undefine
    name: "{{ item.item.name }}"
  when:
    - item.item.name in kvm_existing_vms.list_vms
    - item.item.state|d('running') == 'undefined'
  with_items: "{{ kvm_pool_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"

- name: LV for VM disk
  lvol:
    lv: "vm_{{ item.item.name }}"
    vg: "{{ item.stdout_lines[0]|basename }}"
    size: "{{ item.item.disk_gb|d('16') }}G"
    state: "{{ (item.item.state|d('running') == 'undefined')|ternary('absent','present') }}"
    force: "{{ (item.item.state|d('running') == 'undefined')|ternary('yes','no') }}"
  when:
    - item.item.name not in kvm_existing_vms.list_vms
    - item.stdout_lines[1] == "logical"
  with_items: "{{ kvm_pool_result.results }}"
  loop_control:
    label: "{{ item.item.name|d('null') }}"

- name: Create VM disk from template (with virt-sysprep)
  shell: >
    virt-sysprep --quiet --operations customize,lvm-uuids
    {{ kvm_leave_hostname|ternary('','--hostname ' ~ item[0].item.name ~ '.' ~
    item[0].item.domain|default(ansible_nodename.split(".")[1:]|join("."))) }}
    --copy-in {{ kvm_templates_path }}/{{ item[0].item.name }}:/var/local
    --run-command 'mv /var/local/{{ item[0].item.name }}/* /etc/sysconfig/network-scripts'
    {{ (item[0].item.sysprep_root_pass is defined)
    |ternary('--root-password password:' ~ item[0].item.sysprep_root_pass|d(),'') }}
    {{ (kvm_sysprep_root_key is defined)
    |ternary('--ssh-inject "root:string:' ~ kvm_sysprep_root_key ~ '"'|d(),'') }}
    -a {{ kvm_templates_path }}/{{ item[0].item.template_name }} &&
    qemu-img convert -q -O {{ item[0].item.disk_format|d('raw') }}
    {{ kvm_templates_path }}/{{ item[0].item.template_name }}
    {{ item[0].stdout_lines[0] }}/vm_{{ item[0].item.name }}
  when:
    - item[0].item.name not in kvm_existing_vms.list_vms
    - item[0].item.state|d('running') != 'undefined'
    - not item[1].stat.exists
  with_together:
    - "{{ kvm_pool_result.results }}"
    - "{{ kvm_disk_stat.results }}"
  loop_control:
    label: "{{ item[0].item.name|d('null') }}"

- include: rm_images.yml

- name: Resize VM storage (file)
  command: >
    qemu-img resize -q {{ item.stdout_lines[0] }}/vm_{{ item.item.name }}
    {{ item.item.disk_gb|d('16') }}G
  when:
    - item.item.name not in kvm_existing_vms.list_vms
    - item.item.state|d('running') != 'undefined'
    - item.stdout_lines[1] == "dir"
  with_items: "{{ kvm_pool_result.results }}"
  loop_control:
    label: "{{ item.item.name }}:{{ item.item.disk_gb|d('16') }}"

- name: Template VM XML (local)
  become: no
  template:
    src: "vm.j2"
    dest: "{{ kvm_tmp_dir }}/{{ ansible_nodename }}-vm-{{ item.item.name }}.xml.j2"
  with_items: "{{ kvm_pool_result.results }}"
  when:
    - item.item.name not in kvm_existing_vms.list_vms
    - item.item.state|d('running') != 'undefined'
  loop_control:
    label: "{{ item.item.name }}"
  delegate_to: localhost

- name: Virt define
  virt:
    command: define
    name: "{{ item.item.name }}"
    xml: "{{ lookup('template',  kvm_tmp_dir ~ '/' ~ ansible_nodename ~ '-vm-' ~ item.item.name ~ '.xml.j2') }}"
  when:
    - item.item.name not in kvm_existing_vms.list_vms
    - item.item.state|d('running') != 'undefined'
  with_items: "{{ kvm_pool_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
...
