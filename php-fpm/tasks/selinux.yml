---
- name: Set SELinux state
  selinux:
    policy: targeted
    state: "{{ selinux_state }}"

- name: "setroubleshootd fix"
  lineinfile:
    dest: "/etc/tmpfiles.d/setroubleshoot.conf"
    line: 'D /var/run/setroubleshoot 0755 setroubleshoot root -'
    create: yes
    owner: root
    group: root
    mode: 0644
  when:
    - ansible_distribution == "CentOS"
    - ansible_distribution_major_version|int >= 7
  notify: config reboot
  tags: [selinux]

- name: "Toggle booleans"
  seboolean: name={{ item }} state=yes persistent=yes
  with_items:
    - httpd_can_network_connect_db
    - httpd_can_sendmail
    - httpd_setrlimit
  tags: [selinux]
  when: selinux_state != "disabled"

- name: "Add SELinux ports"
  seport:
    ports: "{{ item.port }}"
    proto : tcp
    setype: "{{ item.type }}"
    state: present
  with_items:
    - { port: '9001-9999', type: 'http_port_t' }
    - { port: '6432', type: 'postgresql_port_t' }
  tags: [selinux,selinux_ports]
  when: selinux_state != "disabled"

- name: "Add fcontext httpd_log_t"
  command: "semanage fcontext -a -t httpd_log_t {{ item }}"
  with_items:
    - '/var/www/[-a-zA-Z0-9\.]+/log(/.*)?'
  tags: [selinux]
  when: selinux_state != "disabled"

- name: "Add fcontext httpd_sys_rw_content_t"
  command: "semanage fcontext -a -t httpd_sys_rw_content_t {{ item }}"
  with_items:
    - '/var/www/[-a-zA-Z0-9\.]+/www/uploads(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/storage(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/app/tmp(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/web/assets(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/assets(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/runtime/logs(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/runtime/debug(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/runtime/cache(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/protected/runtime(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/userfiles(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/templates/compile(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/templates/compile_admin(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/_synchro/templates_c(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/bootstrap/cache(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/public/photos(/.*)?'
  tags: [selinux]
  when: selinux_state != "disabled"

- name: "Add fcontext httpd_cache_t"
  command: "semanage fcontext -a -t httpd_cache_t {{ item }}"
  with_items:
    - '/var/www/[-a-zA-Z0-9\.]+/www/cache(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/[-a-zA-Z0-9\.]+/www/cache(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/[-a-zA-Z0-9\.]+/www/application/cache(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/www/engine/cache(/.*)?'
    - '/var/www/[-a-zA-Z0-9\.]+/tmp(/.*)?'
    - '/var/cache/nginx(/.*)?'
  tags: [selinux]
  when: selinux_state != "disabled"

- name: "Add fcontext ssh_home_t"
  command: "semanage fcontext -a -t ssh_home_t {{ item }}"
  with_items:
    - '/var/www/[-a-zA-Z0-9\.]+/\.ssh(/.*)?'
  tags: [selinux]
  when: selinux_state != "disabled"

- name: "restorecon /var/www"
  command: restorecon -R /var/www
  tags: [selinux]
  when: selinux_state != "disabled"
...
