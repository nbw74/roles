# THIS FILE IS MANAGED BY ANSIBLE, ALL CHANGES WILL BE LOST
{% set siteroot = vhost_basedir ~ '/' ~ item.user|d(item.name) ~ '/' ~ item.webroot|d('www') %}

server {

{% include "nginx/listen-plain.j2" %}
    server_name		{{ item.name }}
			www.{{ item.name }}
{% if item.alias is defined %}
{% for name in item.alias %}
			{{ name }}
			www.{{ name }}
{% endfor %}
{% endif %}
			;
    server_name_in_redirect off;

    proxy_set_header	X-Real-IP        $remote_addr;
    proxy_set_header	X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header	Host $host:80;

    set $proxyserver	"http://127.0.0.1:8888";
    set $docroot	"{{ siteroot }}";

    index index.php;
    root {{ siteroot }};

    # Redirect to ssl if need
    if (-f {{ siteroot }}/.htsecure) { rewrite ^(.*)$ https://$host$1 permanent; }

    # Include parameters common to all websites
    include bx/conf/bitrix.conf;
}
{% if item.crypto|d('none') != 'none' %}

server {
{% include "nginx/listen-crypto.j2" %}
    server_name		{{ item.name }}
			;
    # Enable SSL connection
    include		bx/conf/ssl.h;
{% include "nginx/ssl.j2" %}

    server_name_in_redirect	off;

    proxy_set_header	X-Real-IP	$remote_addr;
    proxy_set_header	X-Forwarded-For	$proxy_add_x_forwarded_for;
    proxy_set_header	Host		$host:443;
    proxy_set_header	HTTPS 		YES;

    set $proxyserver	"http://127.0.0.1:8888";
    set $docroot	"{{ siteroot }}";

    index index.php;
    root {{ siteroot }};

    # Include parameters common to all websites
    include bx/conf/bitrix.conf;
}
{% endif %}
