---
- name: Include htpasswd tasks
  include_tasks: htpasswd.yml
  when:
    - op.nginx_auth_basic is defined
    - op.state|d(True)
  loop: "{{ vhost }}"
  loop_control:
    loop_var: op
    label: "{{ op.name }}"
  tags: [ conf, crypto ]

- name: Include Nginx vhost config tasks
  include_tasks: nginx_vhost.yml
  when: op.state|d(True)
  loop: "{{ vhost }}"
  loop_control:
    loop_var: op
    label: "{{ op.name }}"
  tags: [ conf, crypto ]

- name: Remove Nginx vhost config
  file:
    path: "/etc/nginx/conf.d/{{ item.user|d(item.name) }}.conf"
    state: absent
    backup: yes
  when: not item.state|d(true)
  loop: "{{ vhost }}"
  loop_control:
    label: "{{ item.name }}"
  notify: validate nginx
  tags: [ conf, crypto ]
...
